import"./styles.css";import splashSound from"./sounds/splash.mp3";import clappingSound from"./sounds/clapping.mp3";import explosionSound from"./sounds/explosion.mp3";import bubbleSound from"./sounds/bubble.mp3";import drowningSound from"./sounds/drown.mp3";class Ship{constructor(e,t){this.length=e,this.hits=0,this.coordinates=t}isSunk(){return this.length===this.hits}hit(){this.hits+=1}}class GameBoard{constructor(){this.board=[],this.ships=[],this.hitOrMiss="",this.currentShip=null}createBoard(){for(let e=0;e<10;e++)this.board.push(new Array(10).fill(""))}placeShip(e){e.coordinates.forEach((e=>{let{x:t,y:r}=e;""===this.board[t][r]&&(this.board[t][r]="S")})),this.ships.push(e),e.hits=0}receiveAttack(e,t){let r=!1;this.ships.forEach((o=>{o.coordinates.forEach((a=>{let{x:s,y:n}=a;s===e&&n===t&&(this.currentShip=o,o.hit(),this.hitOrMiss="Hit!",this.board[e][t]="X",r=!0,o.isSunk()&&(this.hitOrMiss="The ship has sunk!"))}))})),r||(this.board[e][t]=".",this.hitOrMiss="Miss!")}attackResult(){return this.hitOrMiss}returnCoordinates(){return this.currentShip.coordinates}reportSunk(){return this.ships.every((e=>e.isSunk()))}}class Player{constructor(){this.playerBoard=new GameBoard}}class RealPlayer extends Player{constructor(e){super(),this.name=e}}class ShipPlacer{constructor(){this.counterOne=4,this.counterTwo=3,this.counterThree=2,this.counterFour=1}static checkShipPlaced(){return 0===this.counterOne&&0===this.counterTwo&&0===this.counterThree&&0===this.counterFour}static updateCounter(e){const t=document.querySelector(".ship-counter-1"),r=document.querySelector(".ship-counter-2"),o=document.querySelector(".ship-counter-3"),a=document.querySelector(".ship-counter-4"),s=document.querySelectorAll("#one-cell-ship div"),n=document.querySelectorAll("#two-cell-ship div"),l=document.querySelectorAll("#three-cell-ship div"),i=document.querySelectorAll("#four-cell-ship div");if(3===e)this.counterThree-=1,o.textContent=this.counterThree;else if(2===e)this.counterTwo=this.counterTwo-1,r.textContent=this.counterTwo;else if(4===e)this.counterFour=this.counterFour-1,a.textContent=this.counterFour;else{if(1!==e)return;this.counterOne=this.counterOne-1,t.textContent=this.counterOne}e=null,this.counterOne<=0&&(document.querySelector("#one-cell-ship").draggable=!1,s.forEach((e=>{e.style.backgroundColor="rgba(255, 255, 255, 0.1)"}))),this.counterTwo<=0&&(document.querySelector("#two-cell-ship").draggable=!1,n.forEach((e=>{e.style.backgroundColor="rgba(255, 255, 255, 0.1)"}))),this.counterThree<=0&&(document.querySelector("#three-cell-ship").draggable=!1,l.forEach((e=>{e.style.backgroundColor="rgba(255, 255, 255, 0.1)"}))),this.counterFour<=0&&(document.querySelector("#four-cell-ship").draggable=!1,i.forEach((e=>{e.style.backgroundColor="rgba(255, 255, 255, 0.1)"})))}static restartShips(){document.querySelector("footer").style.display="flex",document.querySelector(".rotate-button").style.display="block",document.querySelector(".battleship-img").style.display="none";const e=document.querySelectorAll(".ship");e.forEach((e=>{e.style.flexDirection="row"}));const t=document.querySelector(".ship-counter-1"),r=document.querySelector(".ship-counter-2"),o=document.querySelector(".ship-counter-3"),a=document.querySelector(".ship-counter-4");this.counterOne=4,this.counterTwo=3,this.counterThree=2,this.counterFour=1,t.textContent=this.counterOne,r.textContent=this.counterTwo,o.textContent=this.counterThree,a.textContent=this.counterFour,e.forEach((e=>{e.draggable=!0,document.querySelectorAll(".ship div").forEach((e=>{e.style.backgroundColor="rgba(255, 255, 255, 0.5)"}))}))}}class ManageDOM{constructor(e,t){this.player1=new RealPlayer(e),this.player2=new RealPlayer(t),this.currentPlayer=this.player1,this.areShipsVisible=!1,this.init=()=>{this.playerOneBoard(),this.playerTwoBoard(),this.buttonEventListeners(),this.renderNameTags()}}playerOneBoard(){document.querySelector(".gameboard").innerHTML="",this.player1.playerBoard.createBoard(),this.renderBoard(this.player1),this.placeShips(this.player1)}playerTwoBoard(){this.player2.playerBoard.createBoard(),this.renderBoard(this.player2)}areShipsOverlapping(e){if(e.coordinates.some((e=>{let{x:t,y:r}=e;const o=document.querySelector(`.grid-element-${this.currentPlayer.name}[data-col="${r}"][data-row="${t}"]`);return o&&o.classList.contains("unavailable")})))return e=null,this.removeHighlight(),!1}canShipBePlaced(e,t){if(!e.coordinates)return!1;if(!e.coordinates.length===e.size)return!1;const r=(e,t)=>{const r=document.querySelector(`.grid-element-${this.currentPlayer.name}[data-col="${t}"][data-row="${e}"]`);r&&r.classList.add("unavailable")};return"horizontal"===t?(e.coordinates.forEach((e=>{r(e.x-1,e.y),r(e.x+1,e.y)})),r(e.coordinates[0].x,e.coordinates[0].y-1),r(e.coordinates[0].x,e.coordinates[e.length-1].y+1)):(e.coordinates.forEach((e=>{r(e.x,e.y-1),r(e.x,e.y+1)})),r(e.coordinates[0].x-1,e.coordinates[0].y),r(e.coordinates[e.length-1].x+1,e.coordinates[0].y)),!0}removeHighlight(){document.querySelectorAll(`.grid-element-${this.currentPlayer.name}`).forEach((e=>{e.classList.remove("highlight"),e.draggable=!1}))}placeShips(e){ShipPlacer.restartShips(),e.name===this.player2.name&&document.querySelectorAll(`.grid-element-${this.player1.name}`).forEach((e=>{e.style.pointerEvents="none"}));const t=document.querySelectorAll(".ship"),r=document.querySelectorAll(`.grid-element-${e.name}`),o=document.querySelector(".rotate-button");let a=null,s=null,n="horizontal";t.forEach((e=>{e.addEventListener("dragstart",(()=>{a=parseInt(e.getAttribute("data-size"))}))})),o.addEventListener("click",(e=>{e.preventDefault(),n="horizontal"===n?"vertical":"horizontal",t.forEach((e=>{e.style.flexDirection="horizontal"===n?"row":"column"}))})),r.forEach((t=>{t.addEventListener("dragover",(r=>{r.preventDefault(),s=null;let o=parseInt(t.getAttribute("data-col")),l=parseInt(t.getAttribute("data-row"));this.removeHighlight();let i=[];for(let e=0;e<a;e++)"horizontal"===n?4===a||3===a?i.push({x:l,y:o+e-1}):i.push({x:l,y:o+e}):4===a||3===a?i.push({x:l+e-1,y:o}):i.push({x:l+e,y:o});i&&i.every((e=>{let{x:t,y:r}=e;return t>=0&&t<10&&r>=0&&r<10}))&&(i.forEach((t=>{let{x:r,y:o}=t;const a=document.querySelector(`.grid-element-${e.name}[data-col="${o}"][data-row="${r}"]`);a&&a.classList.add("highlight")})),s=new Ship(a,i),this.areShipsOverlapping(s))})),t.addEventListener("dragleave",(()=>{this.removeHighlight()})),t.addEventListener("drop",(t=>{if(this.playBubbleSplashSound(),t.preventDefault(),s.coordinates&&!this.canShipBePlaced(s,n))return void console.log("Cannot place ship!");this.removeHighlight(),ShipPlacer.updateCounter(a),a=null,e.playerBoard.placeShip(s),this.updateBoard(e),this.showShips(),s=null;let r=ShipPlacer.checkShipPlaced();const o=document.querySelector("#player-one-name"),l=document.querySelector("#player-two-name");r&&this.currentPlayer===this.player1?(ShipPlacer.restartShips(),this.hideShips(e),this.currentPlayer=this.player2,o.classList.remove("active"),l.classList.add("active"),this.placeShips(this.player2)):r&&this.currentPlayer===this.player2&&(this.hideShips(e),this.currentPlayer=this.player1,o.classList.add("active"),l.classList.remove("active"),document.querySelectorAll(".grid-container div").forEach((e=>{e.classList.remove(".unavailable")})),this.makeMove())}))}));const l=document.querySelector(".show-ships");l&&(l.style.display="none"),this.createPopup(`${e.name.charAt(0).toUpperCase()+e.name.slice(1)}, place your ships`,1e5)}renderNameTags(){const e=document.querySelector("#player-one-name"),t=document.querySelector("#player-two-name");e.textContent=this.player1.name,t.textContent=this.player2.name}updateBoard(e){for(let t=0;t<e.playerBoard.board.length;t++)for(let r=0;r<e.playerBoard.board[t].length;r++){const o=document.querySelector(`.grid-element-${e.name}[data-col="${r}"][data-row="${t}"]`);"S"===e.playerBoard.board[t][r]?(o.dataset.ship="true",o.textContent=""):o.textContent=e.playerBoard.board[t][r]}}renderBoard(e){const t=document.createElement("div");document.querySelector("h1").style.display="none",document.querySelector(".battleship-img").style.display="none",document.querySelector("footer").style.display="flex",t.classList.add("grid-container"),e.playerBoard.board.forEach(((r,o)=>{r.forEach(((r,a)=>{const s=document.createElement("div");s.dataset.row=o,s.dataset.col=a,s.classList.add(`grid-element-${e.name}`),"S"===r?(s.dataset.ship="true",s.textContent=""):s.textContent=r,t.appendChild(s)}))})),document.querySelector(".gameboard").appendChild(t)}createPopup(e,t){const r=document.querySelector(".popup");r&&r.remove();const o=document.createElement("div");o.classList.add("popup"),o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.classList.add("fade-out")}),t)}playMissSound(){new Audio(splashSound).play()}playExplosionSound(){new Audio(explosionSound).play()}playClappingSound(){new Audio(clappingSound).play()}playBubbleSplashSound(){new Audio(bubbleSound).play()}playDrowningSound(){new Audio(drowningSound).play()}makeMove(){document.querySelector("footer").style.display="none",document.querySelector(".show-ships").style.display="flex",document.querySelector(".rotate-button").style.display="none",document.querySelector(".board-container").style.marginTop="150px",this.createPopup(`Let's begin! ${this.player1.name.slice(0,1).toUpperCase()+this.player1.name.slice(1,this.player1.name.length)} attack first.`,1e4),document.querySelectorAll(".grid-container div").forEach((e=>{e.dataset.clicked="false",e.addEventListener("click",(t=>{let r=this.currentPlayer===this.player1?this.player2:this.player1;if(t.target.classList.contains(`grid-element-${r.name}`))if("false"===e.dataset.clicked){const t=parseInt(e.dataset.row),o=parseInt(e.dataset.col);r.playerBoard.receiveAttack(t,o),e.textContent=r.playerBoard.board[t][o];let a=r.playerBoard.attackResult();"Hit!"===a?(e.style.color="red",this.playExplosionSound()):"The ship has sunk!"===a&&(this.playDrowningSound(),r.playerBoard.returnCoordinates().forEach((e=>{document.querySelectorAll(`.grid-element-${r.name}[data-col="${e.y}"][data-row="${e.x}"]`).forEach((e=>{e.style.color="black"}))}))),e.dataset.clicked="true",r.playerBoard.reportSunk()?(this.playClappingSound(),this.createPopup(`Congrats! ${this.currentPlayer.name.slice(0,1).toUpperCase()+this.currentPlayer.name.slice(1,this.currentPlayer.name.length)} wins!`,1e4),this.restartGameHandler()):"Miss!"===a?(this.createPopup(`${a}`,3e3),this.playMissSound(),this.switchPlayer()):this.createPopup(`${a} Please continue, ${this.currentPlayer.name}!`,3e3)}else this.createPopup("This cell is already clicked!",1500);else this.createPopup("You can't attack your own board!",2e3)}))}))}restartGameHandler(){const e=document.querySelector(".show-ships");e.style.display="none";const t=document.createElement("button");document.querySelector(".show").appendChild(t),t.classList.add(".restart"),t.textContent="Restart Game",this.showAllShips(),document.querySelectorAll(".grid-container div").forEach((e=>{e.style.pointerEvents="none"})),t.addEventListener("click",(()=>{GameManager.restartGame(),document.querySelector(".popup").remove(),document.querySelector(".board-container").style.marginTop="100px",t.style.display="none",e.style.display="block",this.currentPlayer=this.player2,this.switchPlayer()}))}showShips(){const e=document.querySelectorAll(`.grid-element-${this.player1.name}`),t=document.querySelectorAll(`.grid-element-${this.player2.name}`);this.currentPlayer===this.player1?e.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="S")})):this.currentPlayer===this.player2&&t.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="S")})),this.areShipsVisible=!0}hideShips(){const e=document.querySelectorAll(`.grid-element-${this.player1.name}`),t=document.querySelectorAll(`.grid-element-${this.player2.name}`);this.currentPlayer===this.player1?e.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="")})):this.currentPlayer===this.player2&&t.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="")})),this.areShipsVisible=!1}showAllShips(){const e=document.querySelectorAll(`.grid-element-${this.player1.name}`),t=document.querySelectorAll(`.grid-element-${this.player2.name}`);e.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="S")})),t.forEach((e=>{"true"===e.dataset.ship&&("X"===e.textContent?e.textContent="X":e.textContent="S")}))}buttonEventListeners(){const e=document.querySelector(".show-ships");e.replaceWith(e.cloneNode(!0));const t=document.querySelector(".show-ships");t.addEventListener("click",(()=>{if(this.areShipsVisible)this.hideShips(),t.textContent="Show Ships";else{let r=this.currentPlayer===this.player1?this.player2:this.player1;this.createPopup(`${r.name.slice(0,1).toUpperCase()+r.name.slice(1,r.name.length)} close your eyes!`,2e3),e.style.pointerEvents="none",setTimeout((()=>{const r=document.querySelector(".popup");r&&r.remove(),this.showShips(),t.textContent="Hide Ships",e.style.pointerEvents="auto"}),2e3)}}))}switchPlayer(){this.hideShips(),document.querySelector(".show-ships").textContent="Show Ships",this.currentPlayer=this.currentPlayer===this.player1?this.player2:this.player1;let e=this.currentPlayer===this.player1?this.player2:this.player1;document.querySelectorAll(`.grid-element-${e.name}`).forEach((e=>{e.style.pointerEvents="auto"}));const t=document.querySelector("#player-one-name"),r=document.querySelector("#player-two-name");this.currentPlayer.name===this.player1.name?(t.classList.add("active"),r.classList.remove("active")):(r.classList.add("active"),t.classList.remove("active"))}}class GameManager{static createNewGame(){new ManageDOM(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Player 1",arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Player 2").init()}static restartGame(){document.querySelector(".gameboard").innerHTML="",this.getNameInputs()}static getNameInputs(){const e=document.querySelector("form"),t=document.querySelector(".board-container");document.querySelector("h1").style.display="block",document.querySelector(".battleship-img").style.display="block",e.style.display="flex",t.style.display="none",e.addEventListener("submit",(r=>{r.preventDefault();const o=new FormData(r.target),a=Object.fromEntries(o.entries()),s=a.player_one_name.replace(/\s+/g,"_").trim(),n=a.player_two_name.replace(/\s+/g,"_").trim();s!==n?(t.style.display="block",this.createNewGame(s,n),e.style.display="none"):alert("You cannot enter two identical names!")}))}}document.addEventListener("DOMContentLoaded",(()=>{GameManager.getNameInputs()}));